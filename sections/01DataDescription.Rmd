---
output: latex_fragment
bibliography: ../referencesZotero.bib
csl: ../apa.csl
---

```{r}
#| label: section setup
#| include: false

# Global Chunk Options
knitr::opts_chunk$set(
  fig.width = 12,
  fig.height = 8,
  fig.path = "../Figures/",
  include = FALSE,
  warning = FALSE,
  message = FALSE
)
```

```{r}
#| label: missingness filtering

missInfo <- function(full = NA, reduced = NA){
  missTab <- data.frame(
    nFull = nrow(full),
    nRed = nrow(reduced),
    pptFull = length(unique(full$PID)),
    pptRed = length(unique(reduced$PID)),
    timeFull = length(unique(full$TID)),
    timeRed = length(unique(reduced$TID))
  ) %>%
    mutate(
      nDif = nFull-nRed,
      nDifPerc = nDif/nFull*100,
      pptDif = pptFull-pptRed,
      pptDifPerc = pptDif/pptFull*100,
      timeDif = timeFull-timeRed,
      timeDifPerc = timeDif/timeFull*100
    ) %>%
    select(
      nFull, nRed, nDif, nDifPerc,
      pptFull, pptRed, pptDif, pptDifPerc,
      timeFull, timeRed, timeDif, timeDifPerc
    )
    missTab
}

missS1 <- missInfo(full = dtS1$full, reduced = dtS1Red)
missS2 <- missInfo(full = dtS2$full, reduced = dtS2Red)
missS3 <- missInfo(full = dtS3$full, reduced = dtS3Red)

missS123 <- rbind(
  missS1,
  missS2,
  missS3
) %>%
  mutate(study = c(1, 2, 3)) %>%
  select(study, everything())

missS123 %>%
  kbl(.,
      escape = FALSE,
      booktabs = TRUE,
      align = "c", #c("l", rep("c", ncol(.)-1)),
      col.names = c("Study", rep(c("Full","Reduced","$\\Delta$", "%"), 3)),
      digits=2,
      caption = "Missingness Info by Study") %>%
  add_header_above(c(" " = 1, "Measurements" = 4, "Participants" = 4, "Timepoints" = 4)) %>%
  kable_classic(
    full_width = F,
    lightable_options = "hover",
    html_font = "Cambria"
  )
```


We used a data set following migration experiences collected by \citet[][]{Kreienkamp2022b}. The data set consists of three studies that followed migrants who had recently arrived in the Netherlands in their daily interactions with the Dutch majority group members. After a general migration-focused pre-questionnaire, participants were invited twice per day to report on their (potential) interactions with majority group members for at least 30 days. The short ESM surveys were sent out at around lunch (12pm) and dinner time (7pm). After the 30 day study period participants filled in a post-questionnaire that mirrored the pre-questionnaire. Participants received either monetary compensation or partial course credits based on the number of surveys they completed. For our empirical example we focus on the variables that were collected during the ESM surveys and were available in all three studies. Full methodological details are available in \citet[][]{Kreienkamp2022b}.

\subsubsection{Sample}

The original studies included `r sum(missS123$pptFull)` participants ($N_{S1}=$ `r missS123$pptFull[missS123$study==1]`, $N_{S2}=$ `r missS123$pptFull[missS123$study==2]`, $N_{S3}=$ `r missS123$pptFull[missS123$study==3]`) with a total of `r format(sum(missS123$nFull), big.mark=",")` measurements. The studies differed substantially in the maximum length of participation ($\text{max}(t_{S1})=$ `r missS123$timeFull[missS123$study==1]`, $\text{max}(t_{S2})=$ `r missS123$timeFull[missS123$study==2]`, $\text{max}(t_{S3})=$ `r missS123$timeFull[missS123$study==3]`). This was likely due to the option to continue participation without compensation in the later two studies. To make the three studies comparable in participation and time frames, we iteratively removed all measurement occasions and participants that had more than 45% missingness \citep[which was in line with the general rcecommendation for data that might still need to rely on imputations for later model testing][]{Madley-Dowd2019}. This procedure let to a final sample of `r sum(missS123$pptRed)` participants, who jointly produced `r format(sum(missS123$nRed), big.mark=",")` measurements. Importantly, both the participant repsonse-patterns and the time frame were now a lot more comparable ($\text{max}(t_{S1})=$ `r missS123$timeRed[missS123$study==1]`, $\text{max}(t_{S2})=$ `r missS123$timeRed[missS123$study==2]`, $\text{max}(t_{S3})=$ `r missS123$timeRed[missS123$study==3]`). For a full overview of the data reduction procedure and study-specific exclusions see Online Supplemental Material A.


```{r}
#| label: descrWide

variableLab <- c(
  "AttitudesDutch" = "Outgroup Attitude",
  "AttitudesPartner" = "Int: Partner Attitude",
  "DaytimeNeedFulfillment" = "Need Fulfillment",
  "exWB" = "Well-Being",
  "InteractionContextAccidental" = "Int: Accidental",
  "InteractionContextCooperative" = "Int: Cooperative",
  "InteractionContextRepresentativeNL" = "Int: Representative",
  "InteractionContextvoluntary" = "Int: Voluntary",
  "KeyNeedDueToPartner" = "Int: Need Fulfillment Partner",
  "KeyNeedFulfillment" = "Int: Need Fulfillment",
  "qualityMeaning" = "Int: Meaningful",
  "qualityOverall" = "Int: Quality"
) %>% enframe(., name = "variable", value = "label")

dtAll <- rbind(
  dtS1Red %>% select(any_of(varNamS123MiRed)) %>% mutate(study = "S1") %>%
    mutate(across(!TID & !study, as.numeric)),
  dtS2Red %>% select(any_of(varNamS123MiRed)) %>% mutate(study = "S2"),
  dtS3Red %>% select(any_of(varNamS123MiRed)) %>% mutate(study = "S3")
) %>%
  group_by(study, PID) %>%
  mutate(ID = cur_group_id()) %>%
  ungroup %>%
  mutate(date = as.Date(gsub(" .*", "", TID)),
         week = strftime(date, format = "%Y-W%V")) %>%
  select(ID,
         PID,
         study,
         date,
         week,
         TIDnum,
         any_of(varNamS123PCA)) %>%
  arrange(ID, TIDnum) %>%
  select_if(~ sum(!is.na(.)) > 1) %>% # only include variables that have any data (i.e., not all NA)
  as.data.frame

allMlCor <-
  MlCorMat(
    data = dtAll,
    id = "ID",
    selection = c(
      "InteractionContextAccidental", 
      "InteractionContextvoluntary", 
      "InteractionContextCooperative",
      "InteractionContextRepresentativeNL",
      "qualityMeaning",
      "qualityOverall", 
      "KeyNeedFulfillment", 
      "KeyNeedDueToPartner", 
      "AttitudesPartner",
      "DaytimeNeedFulfillment",
      "AttitudesDutch",
      "exWB"
    ),
    labels = c(
      "Int: Accidental", 
      "Int: Voluntary", 
      "Int: Cooperative",
      "Int: Representative",
      "Int: Meaningful",
      "Int: Quality", 
      "Core Need", 
      "Core Need Due to Partner", 
      "Attitude Partner",
      "Daytime Core Need",
      "Outgroup Attitude",
      "Well-being"
    )
  )

# Sample Descriptives Table --- wider version
allMlCor %>%
  t %>%
  as.data.frame %>%
  kbl(.,
      format = "latex",
      caption = "Correlation Table and Descriptive Statistics",
      booktabs = TRUE,
      align = c("l", rep("c", ncol(.) - 1))) %>%
  kable_classic() %>%
  add_header_above(
    .,
    c(
      "",
      "Correlations" = ncol(allMlCor),
      "Descriptives" = nrow(allMlCor) - ncol(allMlCor)
    )
  ) %>%
  footnote(
    general = c(
      "Upper triangle: Between-person correlations;",
      "Lower triangle: Within-person correlations;",
      "*** p < .001, ** p < .01,  * p < .05"
    )
  ) %>%
  kable_styling(latex_options = "scale_down") %>%
  gsub("\\begin{table}", "\\begin{sidewaystable}\n\\centering", ., fixed = TRUE) %>%
  gsub("\\end{table}", "\\end{sidewaystable}", ., fixed = TRUE) %>%
  save_kable("Tables/descrWide.tex")
```

```{r}
#| label: descrLong

# Sample Descriptives Table --- longer version
allMlCor %>%
  as.data.frame %>%
  kbl(.,
      format = "latex",
      caption = "Correlation Table and Descriptive Statistics",
      booktabs = TRUE,
      align = "c", #c("l", rep("c", ncol(.) - 1)),
      escape = FALSE,
      col.names = c(
        #"",
        "\\makecell{Int: \\\\ Accidental}",
        "\\makecell{Int: \\\\ Voluntary}", 
        "\\makecell{Int: \\\\ Cooperative}",
        "\\makecell{Int: \\\\ Representative}",
        "\\makecell{Int: \\\\ Meaningful}",
        "\\makecell{Int: \\\\ Quality}", 
        "Core Need", 
        "\\makecell{Core Need \\\\ Due to Partner}", 
        "\\makecell{Attitude \\\\ Partner}",
        "\\makecell{Daytime \\\\ Core Need}",
        "\\makecell{Outgroup \\\\ Attitude}",
        "Well-being"
      )) %>%
  kable_classic() %>%
  pack_rows("Correlations", 1, ncol(allMlCor)) %>%
  pack_rows("Descriptives", ncol(allMlCor)+1, nrow(allMlCor)) %>%
  footnote(
    general = c(
      "Upper triangle: Between-person correlations;",
      "Lower triangle: Within-person correlations;",
      "*** p < .001, ** p < .01,  * p < .05"
    )
  ) %>%
  kable_styling(latex_options = "scale_down") %>%
  gsub("\\begin{table}", "\\begin{sidewaystable*}[!hbtp]\n\\centering", ., fixed = TRUE) %>%
  gsub("\\end{table}", "\\end{sidewaystable*}", ., fixed = TRUE) %>%
  save_kable("Tables/descrLong.tex")
```

\input{tables/descrLong}
